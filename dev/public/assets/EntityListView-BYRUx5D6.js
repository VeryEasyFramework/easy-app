var J=Object.defineProperty;var Q=(d,i,e)=>i in d?J(d,i,{enumerable:!0,configurable:!0,writable:!0,value:e}):d[i]=e;var P=(d,i,e)=>Q(d,typeof i!="symbol"?i+"":i,e);import{_ as X}from"./ListDetailLayout.vue_vue_type_style_index_0_lang-DPOtSPCH.js";import{d as b,o as f,c as v,w as u,a as o,C as E,b as _,t as T,i as $,F as M,v as S,y as R,m as g,p as Y,z as Z,n as w,q as B,A as N,l as W,B as x,h as ee,D as te,E as ie,g as se,x as ne,G as le,H as ae,T as oe,_ as re}from"./index-BgLTC03-.js";import{C as K}from"./CardWidget-DaiIHUe1.js";import{d as de,_ as q}from"./index-2Ud1_r45.js";import{M as H,_ as D}from"./ButtonIcon.vue_vue_type_script_setup_true_lang-Cv5SDFW7.js";import{f as ue,l as ce,_ as fe}from"./index-FkZDjgsL.js";import{l as pe}from"./index-WTZV_Mn7.js";import"./InputPassword.vue_vue_type_script_setup_true_lang-BAdIyg2q.js";const ye={class:"text-small text-primary bold item-label"},me={class:"text-small italic text-primary-bright"},he=b({__name:"EntityListItem",props:{entityDef:{},record:{},active:{type:Boolean},fields:{}},emits:["select"],setup(d,{emit:i}){return(e,r)=>(f(),v(K,{class:Y(["full-width entity-list-item position-relative",{active:e.active}]),onClick:r[0]||(r[0]=s=>e.$emit("select",e.record.id))},{default:u(()=>[o(E,{class:"row shrink"},{default:u(()=>[o(E,{class:"col shrink horizontal-align-between"},{default:u(()=>[_("div",ye,T(e.record[e.entityDef.config.titleField||"id"]),1)]),_:1}),o(E,{class:"col shrink"},{default:u(()=>[(f(!0),$(M,null,S(e.fields,s=>(f(),$("div",{key:s.key},[_("div",me,[(f(),v(R(g(de)[s.fieldType]),{field:s,format:"date",routePrefix:`/entity/${s.connectionEntity}`,value:e.record[s.key],titleValue:s.connectionTitleField?e.record[s.connectionTitleField]:""},null,8,["field","routePrefix","value","titleValue"]))])]))),128))]),_:1})]),_:1}),o(E,{class:"gap-2 pe-2 pt-1 dates col shrink position-absolute top right"},{default:u(()=>[o(E,{class:"col shrink text-tiny italic overflow-visible"},{default:u(()=>[o(H,{icon:"add",size:"0.6"}),o(q,{value:e.record.createdAt,format:"compact"},null,8,["value"])]),_:1}),o(E,{class:"col shrink text-tiny italic overflow-visible"},{default:u(()=>[o(H,{icon:"update",size:"0.6"}),o(q,{value:e.record.updatedAt,format:"compact"},null,8,["value"])]),_:1})]),_:1})]),_:1},8,["class"]))}}),ve=b({__name:"EasyInput",props:{modelValue:{},field:{},error:{},focus:{type:Boolean},placeholder:{},noLabel:{type:Boolean}},emits:["update:modelValue"],setup(d,{emit:i}){const e=d,r=i,s=Z({get:()=>e.modelValue,set:p=>{r("update:modelValue",p)}});return(p,L)=>(f(),v(R(g(ue)[e.field.fieldType]),{modelValue:s.value,"onUpdate:modelValue":L[0]||(L[0]=c=>s.value=c),field:e.field,required:p.field.required,label:p.field.label,readOnly:p.field.readOnly,error:e.error,name:p.field.key,placeholder:p.placeholder,focus:e.focus,description:p.field.description,noLabel:e.noLabel},null,8,["modelValue","field","required","label","readOnly","error","name","placeholder","focus","description","noLabel"]))}}),Le={class:"title-3"},ge=b({__name:"NewEntityForm",props:{entityDef:{}},emits:["close"],setup(d,{emit:i}){function e(){C("close")}async function r(){if(!p())return;await x.createEntity(L.entityDef.entityId,c.value)&&e()}let s=[];function p(){let n=!0;return h.value={},s.forEach(I=>{c.value[I.key]||(h.value[I.key]="This field is required.",n=!1)}),n}const L=d,c=w({}),h=w({}),C=i;return ce(n=>{n.key==="Escape"&&e(),n.key==="Enter"&&r()}),B(()=>{s=L.entityDef.fields.filter(n=>n.required),s.forEach(n=>{n.defaultValue&&(c.value[n.key]=n.defaultValue)})}),(n,I)=>(f(),v(W,{class:"row-gap-4"},{default:u(()=>[_("div",Le," New "+T(n.entityDef.config.label),1),_("form",{onSubmit:I[0]||(I[0]=N(()=>{},["prevent"]))},[o(E,{class:"col-2 row-gap-4 column-gap-3"},{default:u(()=>[(f(!0),$(M,null,S(n.entityDef.fields.filter(m=>m.required),(m,k)=>(f(),v(ve,{focus:k==0,field:m,error:h.value[m.key],modelValue:c.value[m.key],"onUpdate:modelValue":F=>c.value[m.key]=F,key:m.key},null,8,["focus","field","error","modelValue","onUpdate:modelValue"]))),128))]),_:1})],32),o(E,{class:"col shrink horizontal-align-center"},{default:u(()=>[o(D,{onClick:e,icon:"close",color:"error",size:"1"}),o(D,{type:"submit",onClick:N(r,["prevent"]),icon:"check",color:"success",size:"1"})]),_:1})]),_:1}))}});class _e{constructor(){P(this,"initialized");P(this,"entity");P(this,"listInfo");P(this,"entityList");P(this,"isListLoading",!1);P(this,"listOptions");P(this,"easyApi");this.easyApi=x,this.initialized=!1,this.entityList=w([]),this.listOptions={offset:0},this.listInfo={totalCount:w(0),itemsLoaded:w(0),itemsPerPage:0,listHeight:w(0),limitStart:0,resetScroll:w(!1),currentPage:1}}async init(i){var e;((e=this.entity)==null?void 0:e.entityId)==i.entityId&&(this.entityList.value=[],this.listOptions.columns=i.listFields,this.listOptions.orderBy=i.config.orderField||"updatedAt",this.listOptions.order=i.config.orderDirection||"desc",this.entity=i,this.initialized||(this.initialized=!0))}reset(){this.entityList.value=[],this.listInfo.totalCount.value=0,this.listInfo.itemsLoaded.value=0,this.listInfo.currentPage=1,this.listInfo.limitStart=0}async loadList(){if(!this.isListLoading){this.isListLoading=!0;const{data:i,columns:e,rowCount:r,totalCount:s}=await this.easyApi.getList(this.entity.entityId,{...this.listOptions,offset:this.listInfo.limitStart,limit:this.listInfo.itemsPerPage});this.entityList.value.push(...i),this.listInfo.totalCount.value=s,this.listInfo.itemsLoaded.value=r,this.isListLoading=!1,this.listInfo.resetScroll.value=!0}}async loadMore(i){if(!(this.listInfo.itemsLoaded.value>=this.listInfo.totalCount.value)&&!this.isListLoading){this.isListLoading=!0;const e=this.entityList.value.length,r=i-e+this.listInfo.itemsPerPage,{data:s,columns:p,rowCount:L,totalCount:c}=await this.easyApi.getList(this.entity.entityId,{...this.listOptions,offset:e,limit:r});this.entityList.value.push(...s),this.listInfo.totalCount.value=c,this.listInfo.itemsLoaded.value=this.entityList.value.length,this.listInfo.currentPage=Math.floor(this.entityList.value.length/this.listInfo.itemsPerPage),this.isListLoading=!1}}}const we=b({__name:"TransitionList",props:{fade:{type:Boolean}},setup(d){return(i,e)=>(f(),v(te,{name:i.fade?"list-fade":"list"},{default:u(()=>[ee(i.$slots,"default")]),_:3},8,["name"]))}}),Ie={class:"position-relative input"},ke=b({__name:"EntitySearchInput",props:{entity:{}},emits:["search"],setup(d,{emit:i}){const e=d;let r=[];const s=["DataField","EmailField","TextField","IntField","PhoneField"];B(()=>{if(!e.entity)throw new Error("EntitySearchInput requires an entity prop");r=e.entity.fields.filter(c=>s.includes(c.fieldType))});const p=i;function L(c){const h=c.target.value,C={};r.forEach(n=>{const I=n.fieldType;let m="contains";if(I==="IntField"){const k=parseInt(h);if(isNaN(k))return;m="=",C[n.key]={op:m,value:k};return}C[n.key]={op:m,value:h}}),p("search",C)}return(c,h)=>(f(),$("div",Ie,[_("input",{type:"search",placeholder:"Type to search...",onInput:L},null,32)]))}}),Ee={class:"title-3"},Ce={class:"label text-end"},Pe={class:"grid standard-grid-no-padding list-wrapper"},U=3,G=60,be=b({__name:"EntityList",props:{entity:{},activeEntity:{}},emits:["select"],setup(d,{emit:i}){ie(t=>({"1d39ad03":F,"23ba1585":I,"6bf23ee6":m.value}));const e=new _e,r=d;let s=w();function p(){h.value=!0}function L(){h.value=!1}function c(t){e.listOptions.orFilter=t,e.loadList()}const h=w(!1);let C=[];se(async()=>{const t=ne.entities.find(a=>a.entityId===r.entity);if(!t)return;s.value=t,e.entity=t;const l=t.fields.filter(a=>a.connectionTitleField).map(a=>a.connectionTitleField);C=t.fields.filter(a=>["id","createdAt","updatedAt",t.config.titleField].includes(a.key)?!1:!l.includes(a.key))}),pe(r.entity,async(t,l)=>{switch(t){case"create":await V();break;case"update":let a=!1;e.entityList.value.forEach((y,z)=>{y.id===l.id&&(a=!0,e.entityList.value[z]=l)}),a||await V();break;case"delete":e.entityList.value=e.entityList.value.filter(y=>y.id!==l.id);break}});const n=le("infinite"),I=`${U}px`,m=w("0"),k=G+U,F=`${G}px`;B(async()=>{var l;await e.init(s.value);const t=(l=n.value)==null?void 0:l.parentElement;t&&await O(t),window.addEventListener("resize",V),t==null||t.addEventListener("scroll",A)}),ae(()=>{var l;const t=(l=n.value)==null?void 0:l.parentElement;t==null||t.removeEventListener("scroll",A),window.removeEventListener("resize",V)});async function A(t){const a=t.currentTarget.scrollTop,y=Math.floor(a/k+e.listInfo.itemsPerPage);y+3>e.listInfo.itemsLoaded.value&&(await e.loadMore(y),setTimeout(j,500))}async function j(){var a,y;const t=(y=(a=n.value)==null?void 0:a.parentElement)==null?void 0:y.scrollTop;let l=Math.floor(t/k+e.listInfo.itemsPerPage);l>e.listInfo.totalCount.value&&(l=e.listInfo.totalCount.value),l>e.listInfo.itemsLoaded.value&&await e.loadMore(l)}async function V(){var t;await O((t=n.value)==null?void 0:t.parentElement)}async function O(t){const l=t.getBoundingClientRect(),a=Math.floor(l.height/k);e.listInfo.itemsPerPage=a*2,t.scrollTop=0,e.reset(),await e.loadList(),m.value=`${e.listInfo.totalCount.value*k}px`}return(t,l)=>(f(),v(W,{class:"entity-list-wrapper"},{default:u(()=>{var a;return[_("div",Ee,T((a=g(s))==null?void 0:a.config.label),1),o(K,null,{default:u(()=>[o(E,{class:"list-header col horizontal-align-between"},{default:u(()=>[o(ke,{entity:g(s),onSearch:c},null,8,["entity"]),_("div",null,[o(D,{label:`New ${t.entity}`,onClick:p,icon:"add",size:"1"},null,8,["label"])])]),_:1})]),_:1}),_("div",Ce," Loaded "+T(g(e).listInfo.itemsLoaded)+" of "+T(g(e).listInfo.totalCount)+" records ",1),_("div",Pe,[_("div",{ref_key:"infinite",ref:n,class:"grid standard-grid-no-padding list-container row infinite overflow-hidden"},[o(we,{fade:""},{default:u(()=>[(f(!0),$(M,null,S(g(e).entityList.value,y=>(f(),v(he,{active:t.activeEntity==y.id,key:y.id,entityDef:g(s),fields:g(C),record:y,onSelect:l[0]||(l[0]=z=>t.$emit("select",z))},null,8,["active","entityDef","fields","record"]))),128))]),_:1})],512)]),o(fe,{modelValue:h.value,"onUpdate:modelValue":l[1]||(l[1]=y=>h.value=y)},{default:u(()=>[o(ge,{entityDef:g(e).entity,onClose:L},null,8,["entityDef"])]),_:1},8,["modelValue"])]}),_:1}))}}),Te=b({__name:"EntityListView",props:{entity:{},id:{}},setup(d){const i=d;return(e,r)=>(f(),v(X,{maxWidth:"300px"},{list:u(()=>[(f(),v(be,{entity:e.entity,activeEntity:e.id,onSelect:r[0]||(r[0]=s=>e.$router.push(`/entity/${e.entity}/${s}`)),key:e.entity},null,8,["entity","activeEntity"]))]),detail:u(()=>[(f(),v(oe,{key:i.id}))]),_:1}))}}),Oe=re(Te,[["__scopeId","data-v-12e89caf"]]);export{Oe as default};
