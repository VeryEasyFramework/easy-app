var J=Object.defineProperty;var Q=(r,i,e)=>i in r?J(r,i,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[i]=e;var b=(r,i,e)=>Q(r,typeof i!="symbol"?i+"":i,e);import{_ as X}from"./ListDetailLayout.vue_vue_type_style_index_0_lang-CSlENlUX.js";import{d as P,o as p,c as g,w as d,a,C as E,b as L,t as $,i as V,F as M,v as B,p as Y,y as D,z as Z,m as k,n as _,q as O,A as N,l as W,B as K,h as ee,D as te,E as ie,g as se,x as ne,G as le,H as ae,T as oe,_ as re}from"./index-BIuYyD81.js";import{C as j}from"./CardWidget-CEgwpWs7.js";import{_ as H}from"./DisplayTimestamp.vue_vue_type_script_setup_true_lang-CwZkgo9L.js";import{M as U,_ as S}from"./ButtonIcon.vue_vue_type_script_setup_true_lang-mKvY9iEi.js";import{i as de,l as ue,_ as ce}from"./index-DVjfnBu1.js";import{l as fe}from"./index-Dec2nNcQ.js";import"./InputPassword.vue_vue_type_script_setup_true_lang-DzxX9jck.js";const pe={class:"text-small text-primary bold item-label"},ye={class:"text-small italic text-primary-bright"},me=P({__name:"EntityListItem",props:{entityDef:{},record:{},active:{type:Boolean},fields:{}},emits:["select"],setup(r,{emit:i}){return(e,o)=>(p(),g(j,{class:Y(["full-width entity-list-item position-relative",{active:e.active}]),onClick:o[0]||(o[0]=l=>e.$emit("select",e.record.id))},{default:d(()=>[a(E,{class:"row shrink"},{default:d(()=>[a(E,{class:"col shrink horizontal-align-between"},{default:d(()=>[L("div",pe,$(e.record[e.entityDef.config.titleField||"id"]),1)]),_:1}),a(E,{class:"col shrink"},{default:d(()=>[(p(!0),V(M,null,B(e.fields,l=>(p(),V("div",{key:l},[L("div",ye,$(e.record[l]),1)]))),128))]),_:1})]),_:1}),a(E,{class:"gap-2 pe-2 pt-1 dates col shrink position-absolute top right"},{default:d(()=>[a(E,{class:"col shrink text-tiny italic overflow-visible"},{default:d(()=>[a(U,{icon:"add",size:"0.6"}),a(H,{value:e.record.createdAt,format:"compact"},null,8,["value"])]),_:1}),a(E,{class:"col shrink text-tiny italic overflow-visible"},{default:d(()=>[a(U,{icon:"update",size:"0.6"}),a(H,{value:e.record.updatedAt,format:"compact"},null,8,["value"])]),_:1})]),_:1})]),_:1},8,["class"]))}}),he=P({__name:"EasyInput",props:{modelValue:{},field:{},error:{},focus:{type:Boolean},placeholder:{},noLabel:{type:Boolean}},emits:["update:modelValue"],setup(r,{emit:i}){const e=r;D(()=>{if("required"in e.field)return e.field.required}),D(()=>{if("readOnly"in e.field)return e.field.readOnly});const o=i,l=D({get:()=>e.modelValue,set:c=>{o("update:modelValue",c)}});return(c,v)=>(p(),g(Z(k(de)[e.field.fieldType]),{modelValue:l.value,"onUpdate:modelValue":v[0]||(v[0]=u=>l.value=u),field:e.field,required:c.field.required,label:c.field.label,readOnly:c.field.readOnly,error:e.error,name:c.field.key,placeholder:c.placeholder,focus:e.focus,description:c.field.description,noLabel:e.noLabel},null,8,["modelValue","field","required","label","readOnly","error","name","placeholder","focus","description","noLabel"]))}}),ve={class:"title-3"},Le=P({__name:"NewEntityForm",props:{entityDef:{}},emits:["close"],setup(r,{emit:i}){function e(){C("close")}async function o(){if(!c())return;await K.createEntity(v.entityDef.entityId,u.value)&&e()}let l=[];function c(){let n=!0;return m.value={},l.forEach(w=>{u.value[w.key]||(m.value[w.key]="This field is required.",n=!1)}),n}const v=r,u=_({}),m=_({}),C=i;return ue(n=>{n.key==="Escape"&&e(),n.key==="Enter"&&o()}),O(()=>{l=v.entityDef.fields.filter(n=>n.required),l.forEach(n=>{n.defaultValue&&(u.value[n.key]=n.defaultValue)})}),(n,w)=>(p(),g(W,{class:"row-gap-4"},{default:d(()=>[L("div",ve," New "+$(n.entityDef.config.label),1),L("form",{onSubmit:w[0]||(w[0]=N(()=>{},["prevent"]))},[a(E,{class:"col-2 row-gap-4 column-gap-3"},{default:d(()=>[(p(!0),V(M,null,B(n.entityDef.fields.filter(y=>y.required),(y,I)=>(p(),g(he,{focus:I==0,field:y,error:m.value[y.key],modelValue:u.value[y.key],"onUpdate:modelValue":T=>u.value[y.key]=T,key:y.key},null,8,["focus","field","error","modelValue","onUpdate:modelValue"]))),128))]),_:1})],32),a(E,{class:"col shrink horizontal-align-center"},{default:d(()=>[a(S,{onClick:e,icon:"close",color:"error",size:"1"}),a(S,{type:"submit",onClick:N(o,["prevent"]),icon:"check",color:"success",size:"1"})]),_:1})]),_:1}))}});class _e{constructor(){b(this,"initialized");b(this,"entity");b(this,"listInfo");b(this,"entityList");b(this,"isListLoading",!1);b(this,"listOptions");b(this,"easyApi");this.easyApi=K,this.initialized=!1,this.entityList=_([]),this.listOptions={offset:0},this.listInfo={totalCount:_(0),itemsLoaded:_(0),itemsPerPage:0,listHeight:_(0),limitStart:0,resetScroll:_(!1),currentPage:1}}async init(i){var e;((e=this.entity)==null?void 0:e.entityId)==i.entityId&&(this.entityList.value=[],this.listOptions.columns=i.listFields,this.listOptions.orderBy=i.config.orderField||"updatedAt",this.listOptions.order=i.config.orderDirection||"desc",this.entity=i,this.initialized||(this.initialized=!0))}reset(){this.entityList.value=[],this.listInfo.totalCount.value=0,this.listInfo.itemsLoaded.value=0,this.listInfo.currentPage=1,this.listInfo.limitStart=0}async loadList(){if(!this.isListLoading){this.isListLoading=!0;const{data:i,columns:e,rowCount:o,totalCount:l}=await this.easyApi.getList(this.entity.entityId,{...this.listOptions,offset:this.listInfo.limitStart,limit:this.listInfo.itemsPerPage});this.entityList.value.push(...i),this.listInfo.totalCount.value=l,this.listInfo.itemsLoaded.value=o,this.isListLoading=!1,this.listInfo.resetScroll.value=!0}}async loadMore(i){if(!(this.listInfo.itemsLoaded.value>=this.listInfo.totalCount.value)&&!this.isListLoading){this.isListLoading=!0;const e=this.entityList.value.length,o=i-e+this.listInfo.itemsPerPage,{data:l,columns:c,rowCount:v,totalCount:u}=await this.easyApi.getList(this.entity.entityId,{...this.listOptions,offset:e,limit:o});this.entityList.value.push(...l),this.listInfo.totalCount.value=u,this.listInfo.itemsLoaded.value=this.entityList.value.length,this.listInfo.currentPage=Math.floor(this.entityList.value.length/this.listInfo.itemsPerPage),this.isListLoading=!1}}}const ge=P({__name:"TransitionList",props:{fade:{type:Boolean}},setup(r){return(i,e)=>(p(),g(te,{name:i.fade?"list-fade":"list"},{default:d(()=>[ee(i.$slots,"default")]),_:3},8,["name"]))}}),we={class:"position-relative input"},Ie=P({__name:"EntitySearchInput",props:{entity:{}},emits:["search"],setup(r,{emit:i}){const e=r;let o=[];const l=["DataField","EmailField","TextField","IntField","PhoneField"];O(()=>{if(!e.entity)throw new Error("EntitySearchInput requires an entity prop");o=e.entity.fields.filter(u=>l.includes(u.fieldType))});const c=i;function v(u){const m=u.target.value,C={};o.forEach(n=>{const w=n.fieldType;let y="contains";if(w==="IntField"){const I=parseInt(m);if(isNaN(I))return;y="=",C[n.key]={op:y,value:I};return}C[n.key]={op:y,value:m}}),c("search",C)}return(u,m)=>(p(),V("div",we,[L("input",{type:"search",placeholder:"Type to search...",onInput:v},null,32)]))}}),ke={class:"title-3"},Ee={class:"label text-end"},Ce={class:"grid standard-grid-no-padding list-wrapper"},G=3,R=60,be=P({__name:"EntityList",props:{entity:{},activeEntity:{}},emits:["select"],setup(r,{emit:i}){ie(t=>({ff491e8c:T,"33c84cbc":w,"9d60f746":y.value}));const e=new _e,o=r;let l=_();function c(){m.value=!0}function v(){m.value=!1}function u(t){e.listOptions.orFilter=t,e.loadList()}const m=_(!1);let C=[];se(async()=>{const t=ne.entities.find(s=>s.entityId===o.entity);t&&(l.value=t,e.entity=t,C=t.listFields.filter(s=>!["id","createdAt","updatedAt",t.config.titleField].includes(s)))}),fe(o.entity,async(t,s)=>{switch(t){case"create":await F();break;case"update":let h=!1;e.entityList.value.forEach((f,z)=>{f.id===s.id&&(h=!0,e.entityList.value[z]=s)}),h||await F();break;case"delete":e.entityList.value=e.entityList.value.filter(f=>f.id!==s.id);break}});const n=le("infinite"),w=`${G}px`,y=_("0"),I=R+G,T=`${R}px`;O(async()=>{var s;await e.init(l.value);const t=(s=n.value)==null?void 0:s.parentElement;t&&await A(t),window.addEventListener("resize",F),t==null||t.addEventListener("scroll",q)}),ae(()=>{var s;const t=(s=n.value)==null?void 0:s.parentElement;t==null||t.removeEventListener("scroll",q),window.removeEventListener("resize",F)});async function q(t){const h=t.currentTarget.scrollTop,f=Math.floor(h/I+e.listInfo.itemsPerPage);f+3>e.listInfo.itemsLoaded.value&&(await e.loadMore(f),setTimeout(x,500))}async function x(){var h,f;const t=(f=(h=n.value)==null?void 0:h.parentElement)==null?void 0:f.scrollTop;let s=Math.floor(t/I+e.listInfo.itemsPerPage);s>e.listInfo.totalCount.value&&(s=e.listInfo.totalCount.value),s>e.listInfo.itemsLoaded.value&&await e.loadMore(s)}async function F(){var t;await A((t=n.value)==null?void 0:t.parentElement)}async function A(t){const s=t.getBoundingClientRect(),h=Math.floor(s.height/I);e.listInfo.itemsPerPage=h*2,t.scrollTop=0,e.reset(),await e.loadList(),y.value=`${e.listInfo.totalCount.value*I}px`}return(t,s)=>(p(),g(W,{class:"entity-list-wrapper"},{default:d(()=>{var h;return[L("div",ke,$((h=k(l))==null?void 0:h.config.label),1),a(j,null,{default:d(()=>[a(E,{class:"list-header col horizontal-align-between"},{default:d(()=>[a(Ie,{entity:k(l),onSearch:u},null,8,["entity"]),L("div",null,[a(S,{label:`New ${t.entity}`,onClick:c,icon:"add",size:"1"},null,8,["label"])])]),_:1})]),_:1}),L("div",Ee," Loaded "+$(k(e).listInfo.itemsLoaded)+" of "+$(k(e).listInfo.totalCount)+" records ",1),L("div",Ce,[L("div",{ref_key:"infinite",ref:n,class:"grid standard-grid-no-padding list-container row infinite overflow-hidden"},[a(ge,{fade:""},{default:d(()=>[(p(!0),V(M,null,B(k(e).entityList.value,f=>(p(),g(me,{active:t.activeEntity==f.id,key:f.id,entityDef:k(l),fields:k(C),record:f,onSelect:s[0]||(s[0]=z=>t.$emit("select",z))},null,8,["active","entityDef","fields","record"]))),128))]),_:1})],512)]),a(ce,{modelValue:m.value,"onUpdate:modelValue":s[1]||(s[1]=f=>m.value=f)},{default:d(()=>[a(Le,{entityDef:k(e).entity,onClose:v},null,8,["entityDef"])]),_:1},8,["modelValue"])]}),_:1}))}}),Pe=P({__name:"EntityListView",props:{entity:{},id:{}},setup(r){const i=r;return(e,o)=>(p(),g(X,{maxWidth:"300px"},{list:d(()=>[(p(),g(be,{entity:e.entity,activeEntity:e.id,onSelect:o[0]||(o[0]=l=>e.$router.push(`/entity/${e.entity}/${l}`)),key:e.entity},null,8,["entity","activeEntity"]))]),detail:d(()=>[(p(),g(oe,{key:i.id}))]),_:1}))}}),Oe=re(Pe,[["__scopeId","data-v-12e89caf"]]);export{Oe as default};
