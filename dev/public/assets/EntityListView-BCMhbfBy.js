var Y=Object.defineProperty;var Z=(i,t,e)=>t in i?Y(i,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[t]=e;var P=(i,t,e)=>Z(i,typeof t!="symbol"?t+"":t,e);import{_ as ee}from"./ListDetailLayout.vue_vue_type_style_index_0_lang-PDZpFERH.js";import{d as f,o as l,p as d,t as p,_ as B,B as j,b as u,v as J,D as te,a as g,x,e as L,c as E,w as _,C as D,F as A,z as N,E as ie,l as k,G as U,s as K,h as W,H as se,j as ne,A as ae,I as le,J as oe,K as re,T as ce}from"./index-BYjH4yJH.js";import{C as Q}from"./CardWidget-CLnvhoga.js";import{_ as ue,a as z,l as de,b as fe,c as pe}from"./EasyInput.vue_vue_type_script_setup_true_lang-BTbdhf5x.js";import{M,_ as S}from"./ButtonIcon.vue_vue_type_script_setup_true_lang-Cbo9dm9r.js";import{_ as _e}from"./DisplayChoices.vue_vue_type_style_index_0_lang-di4owrzL.js";import{_ as me}from"./TransitionList.vue_vue_type_style_index_0_lang-BLagXTsR.js";import"./Button.vue_vue_type_script_setup_true_lang-D7t9y8YO.js";import"./InputData.vue_vue_type_script_setup_true_lang-D0e4q8ZS.js";const ve={class:"data-field"},ye=f({__name:"DisplayData",props:{value:{},field:{}},setup(i){const t=i;return(e,s)=>(l(),d("div",ve,p(t.value),1))}}),q=B(ye,[["__scopeId","data-v-565ecf45"]]),he={class:"int-field"},ge=f({__name:"DisplayInt",props:{value:{},field:{}},setup(i){const t=i,e=j(()=>t.value==null?"":t.value);return(s,a)=>(l(),d("div",he,p(e.value),1))}}),Le=f({__name:"DisplayBigInt",props:{value:{},field:{}},setup(i){const t=i;return(e,s)=>(l(),d("div",null,p(t.value),1))}}),Ie=f({__name:"DisplayDate",props:{value:{},field:{}},setup(i){const t=i;return(e,s)=>(l(),d("div",null,p(t.value),1))}}),we=f({__name:"DisplayBoolean",props:{value:{},field:{}},setup(i){return(t,e)=>(l(),d("div",{class:J(["boolean-field",{true:t.value}])},[u(M,{class:"icon",icon:t.value?"check":"close",size:"0.6"},null,8,["icon"])],2))}}),$e=f({__name:"DisplayPassword",props:{value:{},field:{}},setup(i){const t=i;return(e,s)=>(l(),d("div",null,p(t.value),1))}}),Fe=f({__name:"DisplayMultiChoice",props:{value:{},field:{}},setup(i){const t=i;return(e,s)=>(l(),d("div",null,p(t.value),1))}}),ke={class:"text-field"},De=f({__name:"DisplayText",props:{value:{},field:{}},setup(i){const t=i;return(e,s)=>(l(),d("div",ke,p(t.value),1))}}),Ee=f({__name:"DisplayEmail",props:{value:{},field:{}},setup(i){const t=i;return(e,s)=>(l(),d("div",null,p(t.value),1))}}),Ce=f({__name:"DisplayImage",props:{value:{},field:{}},setup(i){const t=i;return(e,s)=>(l(),d("div",null,p(t.value),1))}}),Pe=f({__name:"DisplayPhone",props:{value:{},field:{}},setup(i){const t=i;return(e,s)=>(l(),d("div",null,p(t.value),1))}}),Te=f({__name:"DisplayConnection",props:{value:{},routePrefix:{},field:{},titleValue:{}},setup(i){const t=te();async function e(){const s=`${i.routePrefix}/${i.value}`;await t.push(s)}return(s,a)=>(l(),d("div",{class:"connection-field",onClick:e},p(s.titleValue||s.value),1))}}),xe={class:"decimal-field"},be=f({__name:"DisplayDecimal",props:{value:{},field:{}},setup(i){const t=i,e=j(()=>t.value==null?"":parseFloat(t.value).toFixed(2));return(s,a)=>(l(),d("div",xe,p(e.value),1))}}),Ve={class:"url-field"},ze=["href"],Me=f({__name:"DisplayURL",props:{value:{},field:{}},setup(i){const t=i,e=g();return x(()=>{if(t.value)try{e.value=new URL(t.value)}catch{}}),(s,a)=>{var w,I;return l(),d("div",Ve,[L("a",{href:(w=e.value)==null?void 0:w.href,target:"_blank"},p((I=e.value)==null?void 0:I.href),9,ze)])}}}),Se=B(Me,[["__scopeId","data-v-7506a7d2"]]),Be=f({__name:"DisplayRichText",props:{value:{}},setup(i){return(t,e)=>(l(),d("div",null,p(t.value),1))}}),Ae={IDField:q,DataField:q,IntField:ge,BigIntField:Le,DateField:Ie,BooleanField:we,PasswordField:$e,ChoicesField:_e,MultiChoiceField:Fe,TextField:De,EmailField:Ee,ImageField:Ce,JSONField:ue,PhoneField:Pe,ConnectionField:Te,TimeStampField:z,DecimalField:be,URLField:Se,RichTextField:Be},Ne={class:"text-small text-primary bold item-label"},Re={class:"text-small italic text-primary-bright"},Oe=f({__name:"EntityListItem",props:{entityDef:{},record:{},active:{type:Boolean},fields:{}},emits:["select"],setup(i,{emit:t}){return(e,s)=>(l(),E(Q,{class:J(["px-3 py-2 full-width entity-list-item position-relative",{active:e.active}]),onClick:s[0]||(s[0]=a=>e.$emit("select",e.record.id))},{default:_(()=>[u(D,{class:"row gap-1 shrink overflow-visible"},{default:_(()=>[u(D,{class:"col shrink horizontal-align-between"},{default:_(()=>[L("div",Ne,p(e.record[e.entityDef.config.titleField||"id"]),1)]),_:1}),u(D,{class:"col shrink"},{default:_(()=>[(l(!0),d(A,null,N(e.fields,a=>(l(),d("div",{key:a.key},[L("div",Re,[(l(),E(ie(k(Ae)[a.fieldType]),{field:a,format:"date",routePrefix:`/entity/${a.connectionEntity}`,value:e.record[a.key],titleValue:a.connectionTitleField?e.record[a.connectionTitleField]:""},null,8,["field","routePrefix","value","titleValue"]))])]))),128))]),_:1})]),_:1}),u(D,{class:"gap-2 pe-2 pt-1 dates col shrink position-absolute top right"},{default:_(()=>[u(D,{class:"col shrink text-tiny italic overflow-visible"},{default:_(()=>[u(M,{icon:"add",size:"0.6"}),u(z,{value:e.record.createdAt,format:"compact"},null,8,["value"])]),_:1}),u(D,{class:"col shrink text-tiny italic overflow-visible"},{default:_(()=>[u(M,{icon:"update",size:"0.6"}),u(z,{value:e.record.updatedAt,format:"compact"},null,8,["value"])]),_:1})]),_:1})]),_:1},8,["class"]))}}),Ue={class:"title-3"},qe=f({__name:"NewEntityForm",props:{entityDef:{}},emits:["close"],setup(i,{emit:t}){function e(){C("close")}async function s(){if(!w())return;await W.createEntity(I.entityDef.entityId,v.value)&&e()}let a=[];function w(){let o=!0;return h.value={},a.forEach($=>{v.value[$.key]||(h.value[$.key]="This field is required.",o=!1)}),o}const I=i,v=g({}),h=g({}),C=t;return de(o=>{o.key==="Escape"&&e(),o.key==="Enter"&&s()}),x(()=>{a=I.entityDef.fields.filter(o=>o.required),a.forEach(o=>{o.defaultValue&&(v.value[o.key]=o.defaultValue)})}),(o,$)=>(l(),E(K,{class:"row-gap-4"},{default:_(()=>[L("div",Ue," New "+p(o.entityDef.config.label),1),L("form",{onSubmit:$[0]||($[0]=U(()=>{},["prevent"]))},[u(D,{class:"col-2 row-gap-4 column-gap-3"},{default:_(()=>[(l(!0),d(A,null,N(o.entityDef.fields.filter(y=>y.required),(y,F)=>(l(),E(fe,{focus:F==0,field:y,error:h.value[y.key],modelValue:v.value[y.key],"onUpdate:modelValue":b=>v.value[y.key]=b,key:y.key},null,8,["focus","field","error","modelValue","onUpdate:modelValue"]))),128))]),_:1})],32),u(D,{class:"col shrink horizontal-align-center"},{default:_(()=>[u(S,{onClick:e,icon:"close",color:"error",size:"1"}),u(S,{type:"submit",onClick:U(s,["prevent"]),icon:"check",color:"success",size:"1"})]),_:1})]),_:1}))}});class He{constructor(){P(this,"initialized");P(this,"entity");P(this,"listInfo");P(this,"entityList");P(this,"isListLoading",!1);P(this,"listOptions");P(this,"easyApi");this.easyApi=W,this.initialized=!1,this.entityList=g([]),this.listOptions={offset:0},this.listInfo={totalCount:g(0),itemsLoaded:g(0),itemsPerPage:0,listHeight:g(0),limitStart:0,resetScroll:g(!1),currentPage:1}}async init(t){var e;((e=this.entity)==null?void 0:e.entityId)==t.entityId&&(this.entityList.value=[],this.listOptions.columns=t.listFields,this.listOptions.orderBy=t.config.orderField||"updatedAt",this.listOptions.order=t.config.orderDirection||"desc",this.entity=t,this.initialized||(this.initialized=!0))}reset(){this.entityList.value=[],this.listInfo.totalCount.value=0,this.listInfo.itemsLoaded.value=0,this.listInfo.currentPage=1,this.listInfo.limitStart=0}async loadList(){if(!this.isListLoading){this.isListLoading=!0;const{data:t,columns:e,rowCount:s,totalCount:a}=await this.easyApi.getList(this.entity.entityId,{...this.listOptions,offset:this.listInfo.limitStart,limit:this.listInfo.itemsPerPage});this.entityList.value.push(...t),this.listInfo.totalCount.value=a,this.listInfo.itemsLoaded.value=s,this.isListLoading=!1,this.listInfo.resetScroll.value=!0}}async loadMore(t){if(!(this.listInfo.itemsLoaded.value>=this.listInfo.totalCount.value)&&!this.isListLoading){this.isListLoading=!0;const e=this.entityList.value.length,s=t-e+this.listInfo.itemsPerPage,{data:a,columns:w,rowCount:I,totalCount:v}=await this.easyApi.getList(this.entity.entityId,{...this.listOptions,offset:e,limit:s});this.entityList.value.push(...a),this.listInfo.totalCount.value=v,this.listInfo.itemsLoaded.value=this.entityList.value.length,this.listInfo.currentPage=Math.floor(this.entityList.value.length/this.listInfo.itemsPerPage),this.isListLoading=!1}}}const Ge={class:"position-relative input"},je=f({__name:"EntitySearchInput",props:{entity:{}},emits:["search"],setup(i,{emit:t}){const e=i;let s=[];const a=["DataField","EmailField","TextField","IntField","PhoneField"];x(()=>{if(!e.entity)throw new Error("EntitySearchInput requires an entity prop");s=e.entity.fields.filter(v=>a.includes(v.fieldType))});const w=t;function I(v){const h=v.target.value,C={};s.forEach(o=>{const $=o.fieldType;let y="contains";if($==="IntField"){const F=parseInt(h);if(isNaN(F))return;y="=",C[o.key]={op:y,value:F};return}C[o.key]={op:y,value:h}}),w("search",C)}return(v,h)=>(l(),d("div",Ge,[L("input",{type:"search",placeholder:"Type to search...",onInput:I},null,32)]))}}),Je={class:"title-3"},Ke={class:"label text-end"},We={class:"grid standard-grid-no-padding list-wrapper"},H=3,G=50,Qe=f({__name:"EntityList",props:{entity:{},activeEntity:{}},emits:["select"],setup(i,{emit:t}){se(n=>({"6101a6e1":b,"02d5ae63":$,"1ae9cf78":y.value}));const e=new He,s=i;let a=g();function w(){h.value=!0}function I(){h.value=!1}function v(n){e.listOptions.orFilter=n,e.loadList()}const h=g(!1);let C=[];ne(async()=>{const n=ae.entities.find(c=>c.entityId===s.entity);if(!n)return;a.value=n,e.entity=n;const r=n.fields.filter(c=>c.connectionTitleField).map(c=>c.connectionTitleField);C=n.fields.filter(c=>!n.listFields.includes(c.key)||["id","createdAt","updatedAt",n.config.titleField].includes(c.key)?!1:!r.includes(c.key))}),le(s.entity,async(n,r)=>{switch(n){case"create":await T();break;case"update":let c=!1;e.entityList.value.forEach((m,V)=>{m.id===r.id&&(c=!0,e.entityList.value[V]=r)}),c||await T();break;case"delete":e.entityList.value=e.entityList.value.filter(m=>m.id!==r.id);break}});const o=oe("infinite"),$=`${H}px`,y=g("0"),F=G+H,b=`${G}px`;x(async()=>{var r;await e.init(a.value);const n=(r=o.value)==null?void 0:r.parentElement;n&&await O(n),window.addEventListener("resize",T),n==null||n.addEventListener("scroll",R)}),re(()=>{var r;const n=(r=o.value)==null?void 0:r.parentElement;n==null||n.removeEventListener("scroll",R),window.removeEventListener("resize",T)});async function R(n){const c=n.currentTarget.scrollTop,m=Math.floor(c/F+e.listInfo.itemsPerPage);m+3>e.listInfo.itemsLoaded.value&&(await e.loadMore(m),setTimeout(X,500))}async function X(){var c,m;const n=(m=(c=o.value)==null?void 0:c.parentElement)==null?void 0:m.scrollTop;let r=Math.floor(n/F+e.listInfo.itemsPerPage);r>e.listInfo.totalCount.value&&(r=e.listInfo.totalCount.value),r>e.listInfo.itemsLoaded.value&&await e.loadMore(r)}async function T(){var n;await O((n=o.value)==null?void 0:n.parentElement)}async function O(n){const r=n.getBoundingClientRect(),c=Math.floor(r.height/F);e.listInfo.itemsPerPage=c*2,n.scrollTop=0,e.reset(),await e.loadList(),y.value=`${e.listInfo.totalCount.value*F}px`}return(n,r)=>(l(),E(K,{class:"entity-list-wrapper"},{default:_(()=>{var c;return[L("div",Je,p((c=k(a))==null?void 0:c.config.label),1),u(Q,null,{default:_(()=>[u(D,{class:"list-header col horizontal-align-between"},{default:_(()=>[u(je,{entity:k(a),onSearch:v},null,8,["entity"]),L("div",null,[u(S,{label:`New ${n.entity}`,onClick:w,icon:"add",size:"1"},null,8,["label"])])]),_:1})]),_:1}),L("div",Ke," Loaded "+p(k(e).listInfo.itemsLoaded)+" of "+p(k(e).listInfo.totalCount)+" records ",1),L("div",We,[L("div",{ref_key:"infinite",ref:o,class:"grid standard-grid-no-padding list-container row infinite overflow-hidden"},[u(me,{fade:""},{default:_(()=>[(l(!0),d(A,null,N(k(e).entityList.value,m=>(l(),E(Oe,{active:n.activeEntity==m.id,key:m.id,entityDef:k(a),fields:k(C),record:m,onSelect:r[0]||(r[0]=V=>n.$emit("select",V))},null,8,["active","entityDef","fields","record"]))),128))]),_:1})],512)]),u(pe,{modelValue:h.value,"onUpdate:modelValue":r[1]||(r[1]=m=>h.value=m)},{default:_(()=>[u(qe,{entityDef:k(e).entity,onClose:I},null,8,["entityDef"])]),_:1},8,["modelValue"])]}),_:1}))}}),Xe=f({__name:"EntityListView",props:{entity:{},id:{}},setup(i){const t=i;return(e,s)=>(l(),E(ee,{maxWidth:"300px"},{list:_(()=>[(l(),E(Qe,{entity:e.entity,activeEntity:e.id,onSelect:s[0]||(s[0]=a=>e.$router.push(`/entity/${e.entity}/${a}`)),key:e.entity},null,8,["entity","activeEntity"]))]),detail:_(()=>[(l(),E(ce,{key:t.id}))]),_:1}))}}),rt=B(Xe,[["__scopeId","data-v-12e89caf"]]);export{rt as default};
